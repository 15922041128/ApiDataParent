<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.pbccrc.api.core.mapper.SystemLogMapper">

	<resultMap type="org.pbccrc.api.base.bean.SystemLog" id="systemLog">
		<id property="id" column="id" />
		<result property="uuid" column="uuid" />
		<result property="ipAddress" column="ipAddress" />
		<result property="userID" column="userID" />
		<result property="localApiID" column="localApiID" />
		<result property="params" column="params" />
		<result property="apiKey" column="apiKey" />
		<result property="isSuccess" column="isSuccess" />
		<result property="isCount" column="isCount" />
		<result property="queryDate" column="queryDate" />
		
		<result property="userName" column="userName" />
		<result property="productName" column="productName" />
		<result property="totalNum" column="totalNum" />
		<result property="apiName" column="apiName" />
	</resultMap>
	
	<insert id="addLog" parameterType="org.pbccrc.api.base.bean.SystemLog">
		insert into systemLog(id, uuid, ipAddress, userID, productID, localApiID, params, apiKey, isSuccess, isCount, queryDate) 
			values(seq_systemlog.nextval, #{uuid}, #{ipAddress}, #{userID}, #{productID}, #{localApiID}, #{params}, #{apiKey}, #{isSuccess}, #{isCount}, #{queryDate})
	</insert>
	
	<select id="queryLog" parameterType="org.pbccrc.api.base.bean.SystemLog" resultMap="systemLog">
		select * from systemLog
		<where>
			<if test="userID != null">
				and userID = #{userID}
			</if>
			<if test="localApiID != null">
				and localApiID = #{localApiID}
			</if>
			<if test="startDate != null">
				<![CDATA[
					and queryDate >= #{startDate}  
				]]>
			</if>
			<if test="endDate != null">
				<![CDATA[
					and queryDate <= #{endDate}  
				]]>
			</if>
		</where>
	</select>
	
	<select id="sumLog" parameterType="java.util.HashMap" resultMap="systemLog">
		SELECT
		productID,
		userID,
		u.userName as userName,
		p.name as productName,
		count(1) AS totalNum,
		sum(
			CASE
			WHEN isSuccess = 'true' THEN
				1
			ELSE
				0
			END
		) AS successNum,
		sum(
			CASE
			WHEN isCount = 'true' THEN
				1
			ELSE
				0
			END
		) AS countNum
		FROM
			systemlog s
		LEFT JOIN user u ON s.userID = u.id
		LEFT JOIN product p ON s.productID = p.id
		<where>
		    1=1
			<if test="userName !=null and userName != '' ">
            	and userName like '%'||#{userName}||'%'
        	</if>
        	<if test="productName !=null and productName != '' ">
            	and p.name like '%'||#{productName}||'%' 
        	</if>
			<if test="startDate != null and endDate != ''">
				<![CDATA[
					and s.queryDate >= #{startDate}  
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
					and s.queryDate <= #{endDate}  
				]]>
			</if>
		</where>
		GROUP BY
			userId,
			productID
		
	</select>
	
	<select id="sumApiLog" parameterType="java.util.HashMap" resultMap="systemLog">
		SELECT
		productID,
		userID,
		localApiID,
		l.apiName,
		u.userName,
		p.name as productName,
		count(1) AS totalNum,
		sum(
			CASE
			WHEN isSuccess = 'true' THEN
				1
			ELSE
				0
			END
		) AS successNum,
		sum(
			CASE
			WHEN isSuccess = 'false' THEN
				1
			ELSE
				0
			END
		) AS failureNum,
		sum(
			CASE
			WHEN isCount = 'true' THEN
				1
			ELSE
				0
			END
		) AS countNum
		FROM
			systemlog s
		LEFT JOIN user u ON s.userID = u.id
		LEFT JOIN product p ON s.productID = p.id
		LEFT JOIN localApi l ON s.localApiID = l.id
		<where>
		    1=1
			<if test="userID !=null and userID != '' ">
            	and userID = #{userID} 
        	</if>
        	<if test="productID !=null and productID != '' ">
            	and productID = #{productID}
        	</if>
			<if test="startDate != null and endDate != ''">
				<![CDATA[
					and s.queryDate >= #{startDate}  
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
					and s.queryDate <= #{endDate}  
				]]>
			</if>
		</where>
		GROUP BY
			userId , productID , localApiID
			
		
	</select>
	
	<select id="queryLogDetail" parameterType="java.util.HashMap" resultMap="systemLog">
		SELECT
		ipAddress,
		userID,
		u.userName as userName,
		p.name as productName,
		l.apiName as apiName,
		s.params,
		apiKey,
		isSuccess,
		isCount,
		queryDate
		FROM
			systemlog s
		LEFT JOIN user u ON s.userID = u.id
		LEFT JOIN product p ON s.productID = p.id
		LEFT JOIN localApi l ON s.localApiID = l.id
		<where>
		    1=1
			<if test="userID !=null and userID != '' ">
            	and userID = #{userID} 
        	</if>
        	<if test="productID !=null and productID != '' ">
            	and productID = #{productID}
        	</if>
        	<if test="localApiID !=null and localApiID != '' ">
            	and localApiID = #{localApiID}
        	</if>
        	<if test="isSuccess !=null and isSuccess != '' ">
            	and isSuccess = #{isSuccess}
        	</if>
        		<if test="startDate != null and endDate != ''">
				<![CDATA[
					and s.queryDate >= #{startDate}  
				]]>
			</if>
			<if test="endDate != null and endDate != ''">
				<![CDATA[
					and s.queryDate <= #{endDate}  
				]]>
			</if>
		</where>
		order BY
			queryDate desc
		
	</select>
	
	
</mapper>